<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¡¯ç¤ºä½ å‘¨é­çš„ XXX (Safari å„ªåŒ–ç‰ˆ)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: sans-serif; }
    #map { width: 100%; height: 400px; margin-top: 10px; background-color: #eee; }
    #statusMessage {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      min-height: 1.2em; /* é¿å…æ²’è¨Šæ¯æ™‚è·³å‹• */
      background-color: #f0f0f0;
      border: 1px solid #ccc;
    }
    #statusMessage.success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    #statusMessage.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    #statusMessage.info { background-color: #cce5ff; border-color: #b8daff; color: #004085; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }

    /* â–¼ ç´…è‰²åŠé€æ˜æ³¢ç´‹ï¼ˆæ¨£å¼ä¸è®Šï¼‰ */
    .pulse-marker {
      position: relative;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: rgba(255,0,0,0.55);
    }
    .pulse-marker::before,
    .pulse-marker::after {
      content: ""; position: absolute; left: 50%; top: 50%;
      width: 100%; height: 100%; border-radius: 50%;
      background: rgba(255,0,0,0.35);
      transform: translate(-50%,-50%) scale(0.8);
      animation: pulse 2.5s infinite;
    }
    .pulse-marker::after { animation-delay: 1.25s; }
    @keyframes pulse {
      0%   { transform: translate(-50%,-50%) scale(0.8); opacity: 0.8; }
      70%  { transform: translate(-50%,-50%) scale(3);   opacity: 0; }
      100% { opacity: 0; }
    }
  </style>
</head>

<body>
  <h1>é¡¯ç¤ºä½ å‘¨é­çš„ XXX (Safari å„ªåŒ–ç‰ˆ)</h1>

  <button id="locBtn">ğŸ“ å–å¾—ç›®å‰ä½ç½®</button>
  <button id="copyBtn" disabled>ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button>

  <div id="statusMessage">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†å–å¾—æ‚¨çš„ä½ç½®ã€‚</div>

  <div id="map"></div>

  <script>
    const locBtn = document.getElementById('locBtn');
    const copyBtn = document.getElementById('copyBtn');
    const statusMessageDiv = document.getElementById('statusMessage');
    const mapDiv = document.getElementById('map');

    let map, userMarker, fixedMarkersGroup;
    let currentLatLng = null; // å„²å­˜ç›®å‰å®šä½çš„ç¶“ç·¯åº¦ L.LatLng ç‰©ä»¶
    let latestMapURL = '';     // Google Maps é€£çµ

    // --- Leaflet åœ°åœ–ç›¸é—œå‡½å¼ ---

    function initMap(lat, lon) {
      currentLatLng = L.latLng(lat, lon);
      map = L.map(mapDiv).setView(currentLatLng, 16); // åˆå§‹ç¸®æ”¾ç´šåˆ¥è¨­ç‚º 16
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜ (è—è‰²ï¼Œå€åˆ¥æ–¼å›ºå®šé»)
      userMarker = L.marker(currentLatLng, {
         icon: L.divIcon({
            html: '<svg viewBox="0 0 24 24" width="24px" height="24px" style="fill:%23007AFF;stroke:white;stroke-width:1px;"><circle cx="12" cy="12" r="10"/></svg>',
            className: 'user-location-icon', // å¯ä»¥åŠ  class åšé¡å¤–æ¨£å¼
            iconSize: [24, 24],
            iconAnchor: [12, 12] // å®šä½é»åœ¨ä¸­å¿ƒ
         })
      }).addTo(map).bindPopup("æ‚¨çš„ç›®å‰ä½ç½®").openPopup();

      addFixedMarkers(currentLatLng);
    }

    function updateMap(lat, lon) {
       currentLatLng = L.latLng(lat, lon);
       if (!map) {
         initMap(lat, lon);
       } else {
         map.setView(currentLatLng, map.getZoom()); // åªç§»å‹•è¦–é‡ä¸­å¿ƒï¼Œä¸æ”¹è®Šç¸®æ”¾
         userMarker.setLatLng(currentLatLng);
         addFixedMarkers(currentLatLng); // æ›´æ–°å›ºå®šé»ç›¸å°ä½ç½® (å¦‚æœéœ€è¦)
       }
    }

    function addFixedMarkers(centerLatLng) {
      if (fixedMarkersGroup) fixedMarkersGroup.clearLayers();
      else fixedMarkersGroup = L.layerGroup().addTo(map);

      const pts = [ // ç¯„ä¾‹é»ï¼Œç›¸å°æ–¼ä½¿ç”¨è€…ä½ç½®
        { latOffset: 0.0005, lonOffset: 0.0005 },
        { latOffset: -0.0008, lonOffset: -0.0005 },
        { latOffset: 0,      lonOffset: 0.0009 }
      ];
      const pulseIcon = L.divIcon({ className: 'pulse-marker', iconSize: [16, 16], iconAnchor: [8, 8] });

      pts.forEach(p => {
        L.marker([centerLatLng.lat + p.latOffset, centerLatLng.lng + p.lonOffset], { icon: pulseIcon })
         .addTo(fixedMarkersGroup);
      });
    }

    // --- åœ°ç†å®šä½ç›¸é—œå‡½å¼ ---

    function handleLocationSuccess(pos) {
      setStatus('å®šä½æˆåŠŸï¼æ­£åœ¨æ›´æ–°åœ°åœ–...', 'success');
      locBtn.disabled = false;
      locBtn.textContent = 'ğŸ“ é‡æ–°å®šä½';

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      updateMap(lat, lon);

      // æ›´æ–° Google Maps é€£çµ
      latestMapURL = `https://www.google.com/maps?q=${lat},${lon}`; // ä½¿ç”¨ç¶“ç·¯åº¦åƒæ•¸ï¼Œæ›´é€šç”¨
      copyBtn.disabled = false; // å•Ÿç”¨è¤‡è£½æŒ‰éˆ•

       // å¯ä»¥é¸æ“‡æ€§åœ°æ›´æ–°åº¦åˆ†ç§’é€£çµï¼ˆå¦‚æœåå¥½ï¼‰
       // latestMapURL = `http://maps.google.com/?q=${encodeURIComponent(decimalToDMS(lat, true))}+${encodeURIComponent(decimalToDMS(lon, false))}`;

      setTimeout(() => { // çŸ­æš«é¡¯ç¤ºæˆåŠŸè¨Šæ¯å¾Œæ¸…é™¤
          setStatus('æ‚¨å¯ä»¥æ‹–å‹•åœ°åœ–æˆ–å†æ¬¡å®šä½ã€‚', 'info');
      }, 3000);
    }

    function handleLocationError(error) {
      console.error("Geolocation Error:", error); // åœ¨æ§åˆ¶å°ä¿ç•™è©³ç´°éŒ¯èª¤
      locBtn.disabled = false;
      locBtn.textContent = 'ğŸ“ é‡æ–°å®šä½';
      copyBtn.disabled = true; // å®šä½å¤±æ•—ï¼Œç¦ç”¨è¤‡è£½
      latestMapURL = '';

      let message = `å®šä½å¤±æ•—ï¼š`;
      let instructions = "";

      switch(error.code) {
        case error.PERMISSION_DENIED:
          message += "æ‚¨å·²æ‹’çµ•ç€è¦½å™¨çš„ä½ç½®æ¬Šé™è«‹æ±‚ã€‚";
          instructions = `
            <br><strong>è«‹æª¢æŸ¥æ‚¨çš„ Safari è¨­å®šï¼š</strong>
            <ul>
              <li><strong>åœ¨ macOS ä¸Šï¼š</strong> å‰å¾€ Safari é¸å–® >ã€Œè¨­å®šã€>ã€Œç¶²ç«™ã€>ã€Œä½ç½®ã€ï¼Œæ‰¾åˆ°æ­¤ç¶²ç«™ï¼Œå°‡æ¬Šé™æ”¹ç‚ºã€Œå…è¨±ã€æˆ–ã€Œè©¢å•ã€ã€‚</li>
              <li><strong>åœ¨ iPhone/iPad ä¸Šï¼š</strong> å‰å¾€ç³»çµ±ã€Œè¨­å®šã€App >ã€Œéš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ã€>ã€Œå®šä½æœå‹™ã€(éœ€é–‹å•Ÿ) > å‘ä¸‹æ‰¾åˆ°ã€ŒSafari ç¶²ç«™ã€ï¼Œç¢ºä¿è¨­å®šç‚ºã€Œä¸‹æ¬¡è©¢å•æˆ–åœ¨æˆ‘åˆ†äº«æ™‚ã€æˆ–ã€Œä½¿ç”¨ App æœŸé–“ã€ã€‚(è«‹å‹¿è¨­ç‚ºã€Œæ°¸ä¸ã€)</li>
            </ul>
            ä¿®æ”¹è¨­å®šå¾Œï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦ä¸€æ¬¡ã€‚`;
          break;
        case error.POSITION_UNAVAILABLE:
          message += "ç›®å‰ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®è³‡è¨Šï¼Œå¯èƒ½æ˜¯è¨Šè™Ÿä¸ä½³æˆ–ç¶²è·¯å•é¡Œã€‚";
          break;
        case error.TIMEOUT:
          message += "å˜—è©¦ç²å–ä½ç½®æ™‚ç™¼ç”Ÿè¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
          break;
        default:
          message += `ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ (éŒ¯èª¤ç¢¼ ${error.code})ã€‚`;
          break;
      }
      setStatus(message + instructions, 'error');
    }

    function requestLocation() {
      locBtn.disabled = true;
      locBtn.textContent = 'å®šä½ä¸­...';
      setStatus('æ­£åœ¨è«‹æ±‚æ‚¨çš„ä½ç½®æ¬Šé™...', 'info');
      copyBtn.disabled = true;
      latestMapURL = '';

      navigator.geolocation.getCurrentPosition(
        handleLocationSuccess,
        handleLocationError,
        {
          enableHighAccuracy: true, // å˜—è©¦æ›´é«˜ç²¾åº¦
          timeout: 15000,         // 15 ç§’è¶…æ™‚
          maximumAge: 0           // ä¸ä½¿ç”¨å¿«å–
        }
      );
    }

    // --- æŒ‰éˆ•äº‹ä»¶è™•ç† ---

    locBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        setStatus('æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½ã€‚', 'error');
        locBtn.disabled = true;
        return;
      }

      // å˜—è©¦ä½¿ç”¨ Permissions API é å…ˆæª¢æŸ¥ç‹€æ…‹
      if (navigator.permissions && navigator.permissions.query) {
         setStatus('æ­£åœ¨æª¢æŸ¥ä½ç½®æ¬Šé™...', 'info');
         navigator.permissions.query({ name: 'geolocation' }).then(permissionStatus => {
           console.log('Permission state:', permissionStatus.state); // 'granted', 'prompt', 'denied'

           if (permissionStatus.state === 'granted') {
             setStatus('æ¬Šé™å·²æˆäºˆï¼Œæ­£åœ¨å–å¾—ä½ç½®...', 'info');
             requestLocation();
           } else if (permissionStatus.state === 'prompt') {
             setStatus('éœ€è¦æ‚¨çš„ä½ç½®æ¬Šé™ï¼Œç€è¦½å™¨å°‡æœƒè©¢å•...', 'info');
             requestLocation(); // è§¸ç™¼ç€è¦½å™¨è©¢å•
           } else if (permissionStatus.state === 'denied') {
             // ç›´æ¥èª¿ç”¨éŒ¯èª¤è™•ç†ï¼Œé¡¯ç¤ºè¨­å®šæŒ‡å¼•
             handleLocationError({
                code: GeolocationPositionError.PERMISSION_DENIED, // æ¨¡æ“¬éŒ¯èª¤ç‰©ä»¶
                message: "User denied Geolocation"
             });
             locBtn.disabled = false; // è®“ä½¿ç”¨è€…å¯ä»¥å†æ¬¡é»æ“Šï¼ˆé›–ç„¶å¯èƒ½é‚„æ˜¯å¤±æ•—ï¼‰
             locBtn.textContent = 'ğŸ“ å–å¾—ç›®å‰ä½ç½®';
           }

           // (å¯é¸) ç›£è½æ¬Šé™è®ŠåŒ–
           permissionStatus.onchange = () => {
             console.log('Permission state changed to:', permissionStatus.state);
             setStatus(`ä½ç½®æ¬Šé™ç‹€æ…‹å·²è®Šæ›´ç‚ºï¼š${permissionStatus.state}`, 'info');
             // å¯ä»¥æ ¹æ“šç‹€æ…‹è®ŠåŒ–æ›´æ–° UIï¼Œä¾‹å¦‚å¦‚æœå¾ denied è®Šæˆ grantedï¼Œå¯ä»¥å•Ÿç”¨æŒ‰éˆ•
             if (permissionStatus.state === 'granted' && locBtn.disabled) {
                locBtn.disabled = false;
                locBtn.textContent = 'ğŸ“ å–å¾—ç›®å‰ä½ç½®';
             } else if (permissionStatus.state === 'denied') {
                // å¯èƒ½éœ€è¦å†æ¬¡æç¤ºè¨­å®š
             }
           };

         }).catch(err => {
           console.error("Error querying permissions:", err);
           // å¦‚æœæŸ¥è©¢æ¬Šé™å¤±æ•—ï¼Œé‚„æ˜¯é€€å›ç›´æ¥å˜—è©¦å®šä½
           setStatus('ç„¡æ³•æª¢æŸ¥æ¬Šé™ï¼Œç›´æ¥å˜—è©¦å®šä½...', 'info');
           requestLocation();
         });
      } else {
        // å¦‚æœä¸æ”¯æ´ Permissions APIï¼Œç›´æ¥å˜—è©¦å®šä½
        setStatus('ç€è¦½å™¨ä¸æ”¯æ´æ¬Šé™æª¢æŸ¥ï¼Œç›´æ¥å˜—è©¦å®šä½...', 'info');
        requestLocation();
      }
    });

    copyBtn.addEventListener('click', () => {
      if (!latestMapURL || !navigator.clipboard) {
         setStatus('æ²’æœ‰å¯è¤‡è£½çš„é€£çµï¼Œæˆ–ç€è¦½å™¨ä¸æ”¯æ´è¤‡è£½åŠŸèƒ½ã€‚', 'error');
         return;
       }
       navigator.clipboard.writeText(latestMapURL)
         .then(() => {
           setStatus('åœ°åœ–é€£çµå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
         })
         .catch(err => {
           console.error('Failed to copy: ', err);
           setStatus('è¤‡è£½é€£çµå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚', 'error');
           // æä¾›æ‰‹å‹•è¤‡è£½çš„æ©Ÿæœƒ
           prompt("ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ­¤é€£çµ:", latestMapURL);
         });
    });

    // --- å·¥å…·å‡½å¼ ---

    // åé€²ä½ â†’ åº¦åˆ†ç§’ (å¦‚æœéœ€è¦æ­¤æ ¼å¼çš„é€£çµ)
    function decimalToDMS(deg, isLat = true) {
       const dir = deg >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
       const abs = Math.abs(deg);
       const d = Math.floor(abs);
       const mFloat = (abs - d) * 60;
       const m = Math.floor(mFloat);
       const s = Math.round((mFloat - m) * 60 * 10) / 10;
       return `${d}Â°${m}'${s}"${dir}`;
    }

    // è¨­å®šç‹€æ…‹è¨Šæ¯çš„è¼”åŠ©å‡½å¼
    function setStatus(message, type = 'info') { // type: 'info', 'success', 'error'
      statusMessageDiv.textContent = ''; // æ¸…ç©ºä»¥æ”¯æŒ HTML å…§å®¹
      statusMessageDiv.innerHTML = message; // ä½¿ç”¨ innerHTML ä¾†é¡¯ç¤º HTML æ¨™ç±¤ (å¦‚<ul>)
      statusMessageDiv.className = type; // æ‡‰ç”¨æ¨£å¼
    }

    // --- åˆå§‹åŒ– ---
    setStatus('è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹å®šä½ã€‚åœ°åœ–å°‡åœ¨æˆåŠŸå®šä½å¾Œé¡¯ç¤ºã€‚', 'info'); // åˆå§‹æç¤º

  </script>
</body>
</html>
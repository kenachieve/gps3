<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¡¯ç¤ºä½ å‘¨é­çš„XXX</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: sans-serif; }
    #map{width:100%;height:400px;margin-top:10px; background-color: #eee; } /* Added background color */
    #info { padding: 10px; text-align: center; }
    #getLocationBtn { padding: 10px 15px; font-size: 1em; cursor: pointer; }

    /* ç´…è‰²åŠé€æ˜æ³¢ç´‹ */
    .pulse-marker{
      position:relative;width:16px;height:16px;border-radius:50%;
      background:rgba(255,0,0,0.55);
    }
    .pulse-marker::before,
    .pulse-marker::after{
      content:"";position:absolute;left:50%;top:50%;
      width:100%;height:100%;border-radius:50%;
      background:rgba(255,0,0,0.35);
      transform:translate(-50%,-50%) scale(0.8);
      animation:pulse 2.5s infinite;
    }
    .pulse-marker::after{animation-delay:1.25s;}

    @keyframes pulse{
      0%  {transform:translate(-50%,-50%) scale(0.8);opacity:0.8;}
      70% {transform:translate(-50%,-50%) scale(3);opacity:0;}
      100%{opacity:0;}
    }
  </style>

  <script>
    let map, marker, layerGroup, latestMapURL='';

    /* åé€²ä½ â†’ åº¦åˆ†ç§’ (ä¿®æ­£ URL æ ¼å¼ - å‡è¨­ç”¨æ–¼è¨˜éŒ„) */
    function decimalToDMS(deg,isLat=true){
      const dir=deg>=0?(isLat?'N':'E'):(isLat?'S':'W');
      const a=Math.abs(deg),d=Math.floor(a),
            mFloat=(a-d)*60,m=Math.floor(mFloat),
            s=Math.round((mFloat-m)*60*10)/10;
      return `${d}Â°${m}'${s}"${dir}`;
    }

    /* åŠ å…¥ç´…è‰²æ³¢ç´‹å›ºå®šé» */
    function addFixedMarkers(lat,lon){
      if(layerGroup) layerGroup.clearLayers(); else layerGroup=L.layerGroup(); // Initialize if needed
      const pts=[
        {lat:lat+0.0005, lon:lon+0.0005},
        {lat:lat-0.0008, lon:lon-0.0005},
        {lat,              lon:lon+0.0009}
      ];
      const pulse=L.divIcon({className:'pulse-marker',iconSize:[16,16]});
      pts.forEach(p=>L.marker([p.lat,p.lon],{icon:pulse}).addTo(layerGroup));
      layerGroup.addTo(map);
    }

    /* åˆå§‹åŒ–æˆ–æ›´æ–°åœ°åœ– */
    function setupMap(lat, lon, zoom = 16) { // Default zoom 16
        const mapDiv = document.getElementById('map');
        mapDiv.innerHTML = ''; // Clear any previous messages/content

        if (!map) {
            map = L.map('map').setView([lat, lon], zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            marker = L.marker([lat, lon]).addTo(map);
            addFixedMarkers(lat, lon); // Pass initial lat/lon
        } else {
            map.setView([lat, lon], zoom); // Use provided zoom level
            marker.setLatLng([lat, lon]);
            addFixedMarkers(lat, lon); // Update markers based on new lat/lon
        }
         // Optional: Hide button after success
         // document.getElementById('getLocationBtn').style.display = 'none';
    }


    /* å®šä½æˆåŠŸå›å‘¼ */
    function updateLocation(pos){
        console.log("Location acquired:", pos.coords);
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        // --- æ³¨æ„ï¼šé€™å€‹ URL æ ¼å¼éæ¨™æº–ï¼Œå‡è¨­ç”¨æ–¼å¾Œç«¯è¨˜éŒ„ ---
        const url=`https://www.google.com/maps/@ç·¯åº¦,ç¶“åº¦,ç¸®æ”¾ç­‰ç´šz${
            encodeURIComponent(decimalToDMS(lat,true))}+${
            encodeURIComponent(decimalToDMS(lon,false))}`;
        // --- End of Warning ---
        latestMapURL=url;

        // ä½¿ç”¨ç²å–åˆ°çš„ä½ç½®è¨­å®šåœ°åœ– (ä½¿ç”¨åˆç†çš„ç¸®æ”¾ç­‰ç´š 16)
        setupMap(lat, lon, 16); // Set zoom to 16

        // æ›´æ–°æç¤ºè¨Šæ¯
        document.getElementById('info').textContent = 'å®šä½æˆåŠŸï¼åœ°åœ–å·²æ›´æ–°ã€‚';
    }

    /* å®šä½å¤±æ•—å›å‘¼ */
    function locationError(error) {
        let message = "ç„¡æ³•ç²å–ä½ç½®: ";
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message += "æ‚¨æ‹’çµ•äº†ä½ç½®æ¬Šé™è«‹æ±‚ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚";
                break;
            case error.POSITION_UNAVAILABLE:
                message += "ä½ç½®è³‡è¨Šç›®å‰ç„¡æ³•å–å¾—(å¯èƒ½ç„¡GPSè¨Šè™Ÿæˆ–ç¶²è·¯å•é¡Œ)ã€‚";
                break;
            case error.TIMEOUT:
                message += "ç²å–ä½ç½®è³‡è¨Šè¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                break;
            case error.UNKNOWN_ERROR:
                message += "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚";
                break;
        }
        console.warn(message, error);
        // åœ¨ #info å€åŸŸé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ä½¿ç”¨è€…
        document.getElementById('info').innerHTML = `<span style="color: red;">${message}</span>`;
    }

    /* è«‹æ±‚åœ°ç†ä½ç½® */
    function requestLocation(){
        console.log("Requesting location...");
        document.getElementById('info').textContent = 'æ­£åœ¨å®šä½ä¸­ï¼Œè«‹å…è¨±æ¬Šé™è«‹æ±‚...'; // Provide feedback

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                updateLocation,
                locationError, // ä½¿ç”¨è©³ç´°çš„éŒ¯èª¤è™•ç†å‡½æ•¸
                {
                    enableHighAccuracy: true, // å˜—è©¦é«˜ç²¾ç¢ºåº¦
                    timeout: 15000,          // è¨­å®šè¶…æ™‚æ™‚é–“ (15ç§’)
                    maximumAge: 0           // ä¸ä½¿ç”¨å¿«å–çš„ä½ç½®
                }
            );
        } else {
            console.warn("ç€è¦½å™¨ä¸æ”¯æ´ GPS");
            document.getElementById('info').innerHTML = '<span style="color: red;">æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ GPS å®šä½åŠŸèƒ½ã€‚</span>';
        }
    }

    /* è¤‡è£½é€£çµ */
    function copyLink(){
        if(latestMapURL){
            navigator.clipboard.writeText(latestMapURL)
                .then(()=>alert("åœ°åœ–é€£çµå·²è¤‡è£½ï¼"))
                .catch(err => console.error('è¤‡è£½å¤±æ•—: ', err)); // Added error catching
        }else{
            alert("å°šæœªæˆåŠŸå®šä½ï¼Œç„¡é€£çµå¯è¤‡è£½");
        }
    }

    /* DOMè¼‰å…¥å¾ŒåŸ·è¡Œ */
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–åœ°åœ–é¡¯ç¤ºä¸€å€‹é è¨­ç•«é¢ (ä¾‹å¦‚ï¼šå°ç£å¤§æ¦‚çš„ä½ç½®)
      // é€™æ¨£ä½¿ç”¨è€…é»é€²ä¾†ä¸æœƒçœ‹åˆ°ä¸€ç‰‡ç©ºç™½
      setupMap(23.973, 120.980, 7); // Taiwan approximate center, zoom 7

      // å–å¾—æŒ‰éˆ•ä¸¦ç¶å®šé»æ“Šäº‹ä»¶
      const btn = document.getElementById('getLocationBtn');
      if (btn) {
          btn.addEventListener('click', requestLocation);
      } else {
          console.error("ç„¡æ³•æ‰¾åˆ° ID ç‚º 'getLocationBtn' çš„æŒ‰éˆ•");
      }
    });

  </script>
</head>

<body> <h1>é¡¯ç¤ºä½ å‘¨é­çš„XXX</h1> <p><em>é»æ“Šã€Œç¢ºå®šã€ç«‹å³æŸ¥çœ‹æ‚¨æ‰€åœ¨å€åŸŸçš„æœ€æ–°å‹•æ…‹ï¼</em></p>

  <div id="info">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å®šä½...</div>

  <p style="text-align: center;">
    <button id="getLocationBtn">ğŸ“ é¡¯ç¤ºæˆ‘çš„ä½ç½®èˆ‡å‘¨é‚Šè³‡è¨Š</button>
  </p>

  <p><strong>åœ°åœ–ä½ç½®åˆ†äº«: </strong>
      <button onclick="copyLink()"> ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button>
  </p>

  <div id="map"></div>
</body>
</html>
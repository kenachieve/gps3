<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>é¡¯ç¤ºä½ å‘¨é­çš„ XXX</title>

  <!-- MapKit JS -->
  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"></script>

  <style>
    #map { width: 100%; height: 400px; margin-top: 10px; }

    /* â–¼ ç´…è‰²åŠé€æ˜æ³¢ç´‹ï¼ˆè‡ªè¡Œèª¿æ•´å¤§å°ã€é€æ˜åº¦ã€å‹•ç•«æ™‚é–“ç­‰ï¼‰ */
    .pulse-marker {
      position: relative;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: rgba(255,0,0,0.55);
    }
    .pulse-marker::before,
    .pulse-marker::after {
      content: "";
      position: absolute; left: 50%; top: 50%;
      width: 100%; height: 100%;
      border-radius: 50%;
      background: rgba(255,0,0,0.35);
      transform: translate(-50%,-50%) scale(0.8);
      animation: pulse 2.5s infinite;
    }
    .pulse-marker::after { animation-delay: 1.25s; }
    @keyframes pulse {
      0%   { transform: translate(-50%,-50%) scale(0.8); opacity: .8; }
      70%  { transform: translate(-50%,-50%) scale(3);   opacity: 0; }
      100% { opacity: 0; }
    }
  </style>
</head>

<body>
  <h1>é¡¯ç¤ºä½ å‘¨é­çš„ XXX</h1>

  <button id="locBtn">ğŸ“ å–å¾—ç›®å‰ä½ç½®</button>
  &nbsp; <strong>åœ°åœ–ä½ç½®åˆ†äº«ï¼š</strong>
  <button id="copyBtn">ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button>

  <div id="map"></div>

  <script>
    /* ====== MapKit JS åˆå§‹åŒ– ====== */
    mapkit.init({
      authorizationCallback: done => done("YOUR_MAPKIT_JWT")   // â† æ›æˆä½ çš„ JWT
    });

    let map   = new mapkit.Map("map", {   // å…ˆçµ¦å€‹ä¸–ç•Œè¦–é‡ï¼Œç­‰æœƒå…’å†è·Ÿè¹¤
      showsUserLocation : false,
      rotationEnabled   : false,
      zoomEnabled       : true
    });
    let latestMapURL = "", pulseLayer = [];   // è¤‡è£½ç”¨çš„é€£çµ & è‡ªè¨‚æ³¢ç´‹æ¨™è¨˜

    /* åé€²ä½ â†’ åº¦åˆ†ç§’ï¼ˆç”¢ç”Ÿ Google Maps é€£çµç”¨ï¼‰ */
    function decimalToDMS(deg, isLat = true) {
      const dir = deg >= 0 ? (isLat ? "N" : "E") : (isLat ? "S" : "W");
      const abs = Math.abs(deg);
      const d = Math.floor(abs);
      const mFloat = (abs - d) * 60;
      const m = Math.floor(mFloat);
      const s = Math.round((mFloat - m) * 60 * 10) / 10;
      return `${d}Â°${m}'${s}"${dir}`;
    }

    /* ç”¢ç”Ÿç´…è‰²æ³¢ç´‹ Annotation */
    function addPulse(lat, lon) {
      // æ¸…æ‰èˆŠçš„æ³¢ç´‹
      pulseLayer.forEach(a => map.removeAnnotation(a));
      pulseLayer = [];

      const offsets = [
        [ 0.0005,  0.0005],
        [-0.0008, -0.0005],
        [ 0.0000,  0.0009]
      ];
      offsets.forEach(([dLat, dLon]) => {
        const el = document.createElement("div");
        el.className = "pulse-marker";
        const ann = new mapkit.Annotation(
          new mapkit.Coordinate(lat + dLat, lon + dLon),
          { element: el, anchorOffset: new DOMPoint(8, 8), calloutEnabled: false }
        );
        map.addAnnotation(ann);
        pulseLayer.push(ann);
      });
    }

    /* æ›´æ–°è¤‡è£½ç”¨é€£çµ & æ³¢ç´‹ */
    function handleCoord(lat, lon) {
      latestMapURL =
        `https://www.google.com/maps/place/` +
        encodeURIComponent(decimalToDMS(lat, true)) + "+" +
        encodeURIComponent(decimalToDMS(lon, false));

      addPulse(lat, lon);
    }

    /* 1ï¸âƒ£ å–å¾—å®šä½ï¼ˆä½¿ç”¨è€…æ‰‹å‹¢è§¸ç™¼ï¼‰ */
    document.getElementById("locBtn").onclick = () => {
      map.showsUserLocation = true;                             // é¡¯ç¤ºè—é» :contentReference[oaicite:1]{index=1}
      map.userTrackingMode  = mapkit.UserTrackingMode.follow;   // è¦–é‡è·Ÿéš¨
    };

    /* 2ï¸âƒ£ ç›£è½è—é»åº§æ¨™æ›´æ–° */
    map.addEventListener("userlocationupdate", () => {          // MapKit JS äº‹ä»¶ :contentReference[oaicite:2]{index=2}
      const coord = map.userLocation.coordinate;
      handleCoord(coord.latitude, coord.longitude);
    });

    /* 3ï¸âƒ£ è¤‡è£½ Google Maps é€£çµ */
    document.getElementById("copyBtn").onclick = async () => {
      if (!latestMapURL) { alert("å°šæœªå®šä½ï¼Œæ²’æœ‰å¯è¤‡è£½çš„é€£çµ"); return; }
      try {
        await navigator.clipboard.writeText(latestMapURL);
        alert("åœ°åœ–é€£çµå·²è¤‡è£½!");
      } catch { alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
    };
  </script>
</body>
</html>

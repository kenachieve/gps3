<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS ä½ç½®è¿½è¹¤ï¼ˆOSM ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-top: 10px;
    }
  </style>
  <script>
    let map, marker;

    function getUserIP() {
      return fetch('get_ip.php')
        .then(response => response.json())
        .then(data => data.ip)
        .catch(() => 'ç„¡æ³•ç²å– IP');
    }

    function decimalToDMS(degree, isLatitude = true) {
      const dir = degree >= 0 ? (isLatitude ? 'N' : 'E') : (isLatitude ? 'S' : 'W');
      const absDeg = Math.abs(degree);
      const deg = Math.floor(absDeg);
      const minFloat = (absDeg - deg) * 60;
      const min = Math.floor(minFloat);
      const sec = Math.round((minFloat - min) * 60 * 10) / 10;
      return `${deg}Â°${min}'${sec}"${dir}`;
    }

    function updateShareLinks(googleMapUrl) {
      document.getElementById("share-line").href =
        "https://social-plugins.line.me/lineit/share?url=" + encodeURIComponent(googleMapUrl);
    }

    function copyLink() {
      const url = document.getElementById("google_map_link").href;
      navigator.clipboard.writeText(url).then(() => {
        alert("åœ°åœ–é€£çµå·²è¤‡è£½ï¼");
      });
    }

    function generateRandomNearbyPoints(lat, lon, count = 3, radius = 0.5) {
      const points = [];
      for (let i = 0; i < count; i++) {
        const randDist = Math.random() * radius; // km
        const randAngle = Math.random() * 2 * Math.PI;
        const dx = randDist * Math.cos(randAngle);
        const dy = randDist * Math.sin(randAngle);

        const dLat = dy / 111; // 1Â° â‰ˆ 111km
        const dLon = dx / (111 * Math.cos(lat * Math.PI / 180));

        points.push({ lat: lat + dLat, lon: lon + dLon });
      }
      return points;
    }

     // å›ºå®šä½ç½®æ¨™è¨˜
    function addFixedMarkers(lat, lon) {
      const fixedPoints = [
        { lat: lat + 0.0005, lon: lon + 0.0005 }, // åç§»0.005åº¦ï¼Œç´„555ç±³
        { lat: lat - 0.0008, lon: lon - 0.0005 },
        { lat: lat, lon: lon + 0.0009 }  // åç§»0.005åº¦ï¼Œç´„555ç±³
      ];
      
      fixedPoints.forEach((pt, idx) => {
        L.circle([pt.lat, pt.lon], {
          radius: 25, // åŠå¾‘ï¼ˆå…¬å°ºï¼‰ï¼Œä¾éœ€æ±‚èª¿æ•´
          color: 'green', // é‚Šæ¡†é¡è‰²
          fillColor: 'limegreen', // å¡«å……é¡è‰²
          fillOpacity: 0.25
        })
          .addTo(map)
          .bindPopup(`å€åŸŸ ${idx + 1}`)
          .openPopup();
      });
    }

    function addNearbyMarkers(lat, lon) {
    const nearbyPoints = generateRandomNearbyPoints(lat, lon);
    nearbyPoints.forEach((pt, idx) => {
      L.circle([pt.lat, pt.lon], {
        radius: 25, // åŠå¾‘ï¼ˆå…¬å°ºï¼‰ï¼Œä¾éœ€æ±‚èª¿æ•´
        color: 'green', // é‚Šæ¡†é¡è‰²
        fillColor: 'limegreen', // å¡«å……é¡è‰²
        fillOpacity: 0.25
      })
      .addTo(map)
      .bindPopup(`å€åŸŸ ${idx + 1}`)
      .openPopup();
    });
  }


    function initMap(latitude = 25.0330, longitude = 121.5654) {
      map = L.map('map').setView([latitude, longitude], 45);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([latitude, longitude]).addTo(map)
        .bindPopup("ä½ çš„ä½ç½®")
        .openPopup();

        addFixedMarkers(latitude, longitude);
    }

    function updateLocation(position) {
      let latitude = position.coords.latitude;
      let longitude = position.coords.longitude;

      document.getElementById("latitude").textContent = latitude;
      document.getElementById("longitude").textContent = longitude;

      const lonDMS = decimalToDMS(longitude, false);
      const latDMS = decimalToDMS(latitude, true);
      document.getElementById("dms").textContent = `${lonDMS} ${latDMS}`;

      const encodedLatDMS = encodeURIComponent(latDMS);
      const encodedLonDMS = encodeURIComponent(lonDMS);
      const googleMapDMSUrl = `https://www.google.com/maps/place/${encodedLatDMS}+${encodedLonDMS}`;

      const linkElement = document.getElementById("google_map_link");
      linkElement.href = googleMapDMSUrl;
      linkElement.textContent = `æŸ¥çœ‹åœ°åœ–ï¼š${latDMS} ${lonDMS}`;
      updateShareLinks(googleMapDMSUrl);

      if (!map) {
        initMap(latitude, longitude);
      } else {
        map.setView([latitude, longitude], 45);
        marker.setLatLng([latitude, longitude]);
        addFixedMarkers(latitude, longitude);
      }

      getUserIP().then(userIP => {
        let deviceInfo = navigator.userAgent;
        let data = new FormData();
        data.append('latitude', latitude);
        data.append('longitude', longitude);
        data.append('user_ip', userIP);
        data.append('device_info', deviceInfo);

        fetch('gps_logger.php', {
          method: 'POST',
          body: data
        })
        .then(response => response.json())
        .then(result => {
          document.getElementById("status").textContent = result.message;
          document.getElementById("device_info").textContent = deviceInfo;
          document.getElementById("user-info").textContent = `IP: ${result.ip}, ç«¯å£: ${result.port}`;
        })
        .catch(error => {
          document.getElementById("status").innerHTML = `å‚³è¼¸å¤±æ•—<br>${error}`;
        });
      });
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(updateLocation, error => {
          document.getElementById("status").textContent = "ç„¡æ³•ç²å–ä½ç½®";
        }, { enableHighAccuracy: true });
      } else {
        document.getElementById("status").textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS";
      }
    }
  </script>
</head>
<body onload="getLocation()">
  <h1>GPS ä½ç½®è¿½è¹¤ï¼ˆOSM ç‰ˆï¼‰</h1>
  <p><strong>ç¶“åº¦:</strong> <span id="longitude">ç²å–ä¸­...</span></p>
  <p><strong>ç·¯åº¦:</strong> <span id="latitude">ç²å–ä¸­...</span></p>
  <p><strong>DMS æ ¼å¼:</strong> <span id="dms">ç²å–ä¸­...</span></p>
  <p><strong>Google åœ°åœ–ï¼ˆDMSï¼‰:</strong> <a id="google_map_link" href="#" target="_blank">å°šæœªå®šä½</a></p>

  <!-- åˆ†äº«æŒ‰éˆ•å€ -->
  <div class="share-container">
    <p><strong>LINEåˆ†äº«:</strong><a id="share-line" target="_blank"> ğŸ“± åˆ†äº«åˆ° Line</a></p>
    <p><strong>åœ°åœ–ä½ç½®åˆ†äº«: </strong><button id="copy-btn" onclick="copyLink()"> ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button><br><br></p>
  </div>

  <!-- åœ°åœ– -->
  <div id="map"></div>
</body>
</html>

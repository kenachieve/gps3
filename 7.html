<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap:">
    <title>é¡¯ç¤ºä½ å‘¨é­çš„ XXX</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { padding: 0; margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .container { padding: 15px; }
        #map { width: 100%; height: 400px; margin-top: 10px; border-radius: 8px; }
        button { 
            background: #007AFF; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .pulse-marker {
            position: relative;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,0,0,0.55);
        }
        .pulse-marker::before,
        .pulse-marker::after {
            content: "";
            position: absolute;
            left: 50%; top: 50%;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: rgba(255,0,0,0.35);
            transform: translate(-50%,-50%) scale(0.8);
            animation: pulse 2.5s infinite;
        }
        .pulse-marker::after { animation-delay: 1.25s; }
        @keyframes pulse {
            0%   { transform: translate(-50%,-50%) scale(0.8); opacity: 0.8; }
            70%  { transform: translate(-50%,-50%) scale(3);   opacity: 0; }
            100% { opacity: 0; }
        }
        #status { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f8f8f8; 
            border-radius: 8px;
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>é¡¯ç¤ºä½ å‘¨é­çš„ XXX</h1>
    <div id="status"></div>
    <button id="locBtn">ğŸ“ å–å¾—ç›®å‰ä½ç½®</button>
    <button id="copyBtn">ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button>
    <div id="map"></div>
</div>

<script>
let map, marker, layerGroup;
let latestMapURL = '';
let watchId = null;
const statusDiv = document.getElementById('status');

function showStatus(message, isError = false) {
    statusDiv.style.display = 'block';
    statusDiv.style.background = isError ? '#ffeeee' : '#f8f8f8';
    statusDiv.style.color = isError ? '#cc0000' : '#333333';
    statusDiv.innerHTML = message;
}

function decimalToDMS(deg, isLat = true) {
    const dir = deg >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
    const abs = Math.abs(deg);
    const d = Math.floor(abs);
    const mFloat = (abs - d) * 60;
    const m = Math.floor(mFloat);
    const s = Math.round((mFloat - m) * 60 * 10) / 10;
    return `${d}Â°${m}'${s}"${dir}`;
}

function initMap(lat, lon) {
    if (map) {
        map.remove();
    }
    
    map = L.map('map').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    marker = L.marker([lat, lon]).addTo(map);
    addFixedMarkers(lat, lon);
}

function addFixedMarkers(lat, lon) {
    if (layerGroup) layerGroup.clearLayers();
    layerGroup = L.layerGroup().addTo(map);
    const pts = [
        { lat: lat + 0.0005, lon: lon + 0.0005 },
        { lat: lat - 0.0008, lon: lon - 0.0005 },
        { lat: lat,          lon: lon + 0.0009 }
    ];
    const pulse = L.divIcon({ className: 'pulse-marker', iconSize: [16, 16] });
    pts.forEach(p => L.marker([p.lat, p.lon], { icon: pulse }).addTo(layerGroup));
}

function updateLocation(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const accuracy = Math.round(pos.coords.accuracy);
    
    showStatus(`ä½ç½®å·²æ›´æ–°ï¼ç²¾ç¢ºåº¦: ${accuracy} å…¬å°º`);
    
    latestMapURL =
        `https://www.google.com/maps/place/` +
        encodeURIComponent(decimalToDMS(lat, true)) + '+' +
        encodeURIComponent(decimalToDMS(lon, false));
    
    if (!map) {
        initMap(lat, lon);
    } else {
        map.setView([lat, lon], 15);
        marker.setLatLng([lat, lon]);
        addFixedMarkers(lat, lon);
    }
}

function handleGeoError(err) {
    let msg = '';
    
    switch(err.code) {
        case 1:
            msg = 'å·²æ‹’çµ•å®šä½æ¬Šé™ã€‚<br><br>è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿé–‹å•Ÿï¼š<br>1. åœ¨ Safari ä¸­é»æ“Šç¶²å€åˆ—å·¦å´çš„ã€ŒaAã€<br>2. é¸æ“‡ã€Œç¶²ç«™è¨­å®šã€<br>3. å°‡ã€Œä½ç½®ã€è¨­ç‚ºã€Œå…è¨±ã€<br><br>æˆ–åˆ° è¨­å®š â†’ Safari â†’ é€²éš â†’ ç¶²ç«™è³‡æ–™ â†’ æ¸…é™¤æ‰€æœ‰ç¶²ç«™è³‡æ–™';
            break;
        case 2:
            msg = 'ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹ç¢ºèªæ‚¨çš„ç¶²è·¯é€£ç·šæ­£å¸¸ä¸”å·²é–‹å•Ÿå®šä½æœå‹™ã€‚<br><br>åœ¨ iPhone/iPad ä¸Šï¼šè¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ â†’ å®šä½æœå‹™ â†’ ç¢ºèªå·²é–‹å•Ÿ';
            break;
        case 3:
            msg = 'å®šä½è«‹æ±‚é€¾æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–ç§»å‹•åˆ°è¨Šè™Ÿè¼ƒä½³çš„ä½ç½®';
            break;
        default:
            msg = `å®šä½å¤±æ•—ï¼š${err.message}`;
    }
    
    showStatus(msg, true);
}

document.getElementById('locBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
        showStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½', true);
        return;
    }
    
    showStatus('æ­£åœ¨å–å¾—ä½ç½®...');
    
    // å…ˆæ¸…é™¤ä¹‹å‰çš„ç›£è½
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
    }
    
    // å…ˆå˜—è©¦å–®æ¬¡å®šä½
    navigator.geolocation.getCurrentPosition(
        updateLocation,
        handleGeoError,
        { 
            enableHighAccuracy: true, 
            timeout: 15000, 
            maximumAge: 0 
        }
    );
    
    // ç„¶å¾Œè¨­ç½®æŒçºŒç›£è½ä»¥ç²å¾—æ›´ç²¾ç¢ºçš„ä½ç½®
    watchId = navigator.geolocation.watchPosition(
        updateLocation,
        handleGeoError,
        { 
            enableHighAccuracy: true, 
            timeout: 15000, 
            maximumAge: 0 
        }
    );
    
    // 30ç§’å¾Œè‡ªå‹•åœæ­¢ç›£è½ä»¥ç¯€çœé›»é‡
    setTimeout(() => {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    }, 30000);
});

document.getElementById('copyBtn').addEventListener('click', () => {
    if (!latestMapURL) {
        showStatus('å°šæœªå®šä½ï¼Œæ²’æœ‰å¯è¤‡è£½çš„é€£çµ', true);
        return;
    }
    
    // é‡å° iOS Safari çš„ç‰¹æ®Šè™•ç†
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(latestMapURL)
            .then(() => showStatus('åœ°åœ–é€£çµå·²è¤‡è£½ï¼'))
            .catch(() => {
                // å¦‚æœ clipboard API å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = latestMapURL;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    showStatus(successful ? 'åœ°åœ–é€£çµå·²è¤‡è£½ï¼' : 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
                } catch (err) {
                    showStatus('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š' + latestMapURL);
                }
                
                document.body.removeChild(textArea);
            });
    } else {
        // èˆŠæ–¹æ³•å‚™ç”¨
        const textArea = document.createElement('textarea');
        textArea.value = latestMapURL;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            showStatus(successful ? 'åœ°åœ–é€£çµå·²è¤‡è£½ï¼' : 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
        } catch (err) {
            showStatus('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š' + latestMapURL);
        }
        
        document.body.removeChild(textArea);
    }
});

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ¬Šé™
document.addEventListener('DOMContentLoaded', () => {
    if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'geolocation' })
            .then(permissionStatus => {
                if (permissionStatus.state === 'denied') {
                    showStatus('æ‚¨å·²æ‹’çµ•å®šä½æ¬Šé™ã€‚è«‹åœ¨ Safari è¨­å®šä¸­é‡æ–°å…è¨±ã€‚', true);
                } else if (permissionStatus.state === 'granted') {
                    showStatus('å·²å–å¾—å®šä½æ¬Šé™ï¼Œé»æ“ŠæŒ‰éˆ•é–‹å§‹å®šä½');
                } else {
                    showStatus('é»æ“ŠæŒ‰éˆ•é–‹å§‹å®šä½');
                }
                
                permissionStatus.onchange = function() {
                    if (this.state === 'granted') {
                        showStatus('å·²å–å¾—å®šä½æ¬Šé™ï¼Œé»æ“ŠæŒ‰éˆ•é–‹å§‹å®šä½');
                    }
                };
            })
            .catch(error => {
                console.log('æ¬Šé™æŸ¥è©¢å¤±æ•—:', error);
            });
    }
});
</script>
</body>
</html>
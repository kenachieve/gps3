<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS ä½ç½®è¿½è¹¤ï¼ˆOSM ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map {
      width: 600px;  /* å›ºå®šå¯¬åº¦ */
      height: 400px; /* å›ºå®šé«˜åº¦ */
      margin-top: 10px;
      position: relative; /* ç¢ºä¿åœ“åœˆåœ–å±¤ä½ç½®ç›¸å°æ–¼åœ°åœ– */
    }

    /* åœ“åœˆåœ–å±¤è¨­å®š */
    .circle-layer {
      position: absolute;
      width: 50px;  /* å›ºå®šåœ“åœˆçš„å¤§å° */
      height: 50px;
      border-radius: 50%;
      background-color: rgba(0, 255, 0, 0.3); /* é»˜èªé¡è‰² */
      z-index: 9999; /* ç¢ºä¿åœ“åœˆåœ¨ä¸Šå±¤ */
    }

    /* è¨­å®šåœ“åœˆçš„é¡è‰² */
    .circle-layer.one {
      background-color: rgba(255, 0, 0, 0.5); /* ç´…è‰² */
    }

    .circle-layer.two {
      background-color: rgba(255, 0, 0, 0.5); /* è—è‰² */
    }

    .circle-layer.three {
      background-color: rgba(255, 0, 0, 0.5); /* é’è‰² */
    }

    /* è¨­å®šåœ“åœˆåœ¨é é¢ä¸‹æ–¹50%çš„ä½ç½® */
    .circle-layer-container {
      position: absolute;  /* å¾ fixed æ”¹æˆ absolute */
      width: 100%;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      z-index: 10000;
      pointer-events: none;
    }

  </style>
  <script>
    let map, marker;

    function getUserIP() {
      return fetch('get_ip.php')
        .then(response => response.json())
        .then(data => data.ip)
        .catch(() => 'ç„¡æ³•ç²å– IP');
    }

    function decimalToDMS(degree, isLatitude = true) {
      const dir = degree >= 0 ? (isLatitude ? 'N' : 'E') : (isLatitude ? 'S' : 'W');
      const absDeg = Math.abs(degree);
      const deg = Math.floor(absDeg);
      const minFloat = (absDeg - deg) * 60;
      const min = Math.floor(minFloat);
      const sec = Math.round((minFloat - min) * 60 * 10) / 10;
      return `${deg}Â°${min}'${sec}"${dir}`;
    }

    function initMap(latitude = 25.0330, longitude = 121.5654) {
      map = L.map('map', {
        center: [latitude, longitude],
        zoom: 17,
        dragging: false,
        zoomControl: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        touchZoom: false,
        boxZoom: false,
        keyboard: false
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([latitude, longitude]).addTo(map)
        .bindPopup("ä½ çš„ä½ç½®")
        .openPopup();
      
      // åœ¨åœ°åœ–ä¸‹æ–¹é¡¯ç¤ºä¸‰å€‹åœ“åœˆ
      addCircleLayer(latitude, longitude);
    }

    function addCircleLayer(lat, lon) {
      const circleCoords = [
        { latOffset: 0.0015, lonOffset: 0.0015, className: 'one' },
        { latOffset: 0.0003, lonOffset: -0.001, className: 'two' },
        { latOffset: 0.0013, lonOffset: 0.0007, className: 'three' }
      ];

      // âœ… æ”¹ç‚ºç›¸å°æ–¼åœ°åœ–å®¹å™¨å®šä½
      const mapContainer = map.getContainer();
      const circleContainer = document.createElement('div');
      circleContainer.classList.add('circle-layer-container');
      mapContainer.appendChild(circleContainer);  // â¬…ï¸ æ”¹æˆåŠ åˆ°åœ°åœ–å®¹å™¨

      circleCoords.forEach((coord) => {
        const circleDiv = document.createElement('div');
        circleDiv.classList.add('circle-layer', coord.className);

        const latLng = map.latLngToContainerPoint([lat + coord.latOffset, lon + coord.lonOffset]);
        circleDiv.style.left = `${latLng.x - 25}px`;
        circleDiv.style.top = `${latLng.y - 25}px`;

        circleContainer.appendChild(circleDiv);
      });
    }

    function updateLocation(position) {
      let latitude = position.coords.latitude;
      let longitude = position.coords.longitude;

      document.getElementById("latitude").textContent = latitude;
      document.getElementById("longitude").textContent = longitude;

      const lonDMS = decimalToDMS(longitude, false);
      const latDMS = decimalToDMS(latitude, true);
      document.getElementById("dms").textContent = `${lonDMS} ${latDMS}`;

      const encodedLatDMS = encodeURIComponent(latDMS);
      const encodedLonDMS = encodeURIComponent(lonDMS);
      const googleMapDMSUrl = `https://www.google.com/maps/place/${encodedLatDMS}+${encodedLonDMS}`;

      const linkElement = document.getElementById("google_map_link");
      linkElement.href = googleMapDMSUrl;
      linkElement.textContent = `æŸ¥çœ‹åœ°åœ–ï¼š${latDMS} ${lonDMS}`;

      if (!map) {
        initMap(latitude, longitude);
      } else {
        map.setView([latitude, longitude], 17);
        marker.setLatLng([latitude, longitude]);
      }

      getUserIP().then(userIP => {
        let deviceInfo = navigator.userAgent;
        let data = new FormData();
        data.append('latitude', latitude);
        data.append('longitude', longitude);
        data.append('user_ip', userIP);
        data.append('device_info', deviceInfo);

        fetch('gps_logger.php', {
          method: 'POST',
          body: data
        })
        .then(response => response.json())
        .then(result => {
          document.getElementById("status").textContent = result.message;
        })
        .catch(error => {
          document.getElementById("status").innerHTML = `å‚³è¼¸å¤±æ•—<br>${error}`;
        });
      });
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(updateLocation, error => {
          document.getElementById("status").textContent = "ç„¡æ³•ç²å–ä½ç½®";
        }, { enableHighAccuracy: true });
      } else {
        document.getElementById("status").textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS";
      }
    }

    function copyLink() {
      const latitude = document.getElementById('latitude').textContent;
      const longitude = document.getElementById('longitude').textContent;
      const url = `https://www.google.com/maps?q=${latitude},${longitude}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('åœ°åœ–é€£çµå·²è¤‡è£½!');
      }).catch(err => {
        alert('ç„¡æ³•è¤‡è£½é€£çµ');
      });
    }
  </script>
</head>
<body onload="getLocation()">
  <h1>GPS ä½ç½®è¿½è¹¤ï¼ˆOSM ç‰ˆï¼‰</h1>
  <p><strong>ç¶“åº¦:</strong> <span id="longitude">ç²å–ä¸­...</span></p>
  <p><strong>ç·¯åº¦:</strong> <span id="latitude">ç²å–ä¸­...</span></p>
  <p><strong>DMS æ ¼å¼:</strong> <span id="dms">ç²å–ä¸­...</span></p>
  <p><strong>Google åœ°åœ–ï¼ˆDMSï¼‰:</strong> <a id="google_map_link" href="#" target="_blank">å°šæœªå®šä½</a></p>

  <!-- åˆ†äº«æŒ‰éˆ•å€ -->
  <div class="share-container">
    <p><strong>LINEåˆ†äº«:</strong><a id="share-line" target="_blank"> ğŸ“± åˆ†äº«åˆ° Line</a></p>
    <p><strong>åœ°åœ–ä½ç½®åˆ†äº«: </strong><button id="copy-btn" onclick="copyLink()"> ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button><br><br></p>
  </div>

  <!-- åœ°åœ– -->
  <div id="map"></div>
</body>
</html>

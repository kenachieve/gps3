<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¡¯ç¤ºä½ å‘¨é­çš„XXX</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --primary:#e53935;/* ä¸»è‰²ï¼Œå¯è‡ªè¡Œèª¿æ•´ */
    }
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:1rem;}
    #map{width:100%;height:400px;margin-top:10px;}

    /* ç´…è‰²åŠé€æ˜æ³¢ç´‹ï¼ˆèª¿æ•´ï¼š--pulse-size, --pulse-opacity, animation æ™‚é–“ï¼‰ */
    .pulse-marker{
      position:relative;width:16px;height:16px;border-radius:50%;
      background:rgba(255,0,0,0.55);
    }
    .pulse-marker::before,
    .pulse-marker::after{
      content:"";position:absolute;left:50%;top:50%;
      width:100%;height:100%;border-radius:50%;
      background:rgba(255,0,0,0.35);
      transform:translate(-50%,-50%) scale(0.8);
      animation:pulse 2.5s infinite;
    }
    .pulse-marker::after{animation-delay:1.25s;}
    @keyframes pulse{
      0%  {transform:translate(-50%,-50%) scale(0.8);opacity:0.8;}
      70% {transform:translate(-50%,-50%) scale(3);opacity:0;}
      100%{opacity:0;}
    }
    #status{margin-top:0.5rem;color:#555;font-size:0.9rem;}
    #loc-btn{background:var(--primary);border:none;color:#fff;padding:0.6rem 1rem;border-radius:4px;font-size:1rem;cursor:pointer;}
    #loc-btn:disabled{opacity:0.5;cursor:not-allowed;}
  </style>
</head>
<body>
  <h1>é¡¯ç¤ºä½ å‘¨é­çš„XXX</h1>
  <p><em>é»æ“Šã€Œç¢ºå®šã€ç«‹å³æŸ¥çœ‹æ‚¨æ‰€åœ¨å€åŸŸçš„æœ€æ–°å‹•æ…‹ï¼</em></p>
  <button id="loc-btn">ç¢ºå®š</button>
  <span id="status"></span>
  <p style="margin-top:1rem"><strong>åœ°åœ–ä½ç½®åˆ†äº«: </strong>
    <button onclick="copyLink()"> ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button>
  </p>
  <div id="map"></div>

<script>
let map, marker, layerGroup, latestMapURL='';
const statusEl = document.getElementById('status');
const btn = document.getElementById('loc-btn');

/* åé€²ä½ â†’ åº¦åˆ†ç§’ï¼Œç”¨æ–¼ Google Maps é€£çµ */
function decimalToDMS(deg,isLat=true){
  const dir=deg>=0?(isLat?'N':'E'):(isLat?'S':'W');
  const a=Math.abs(deg),d=Math.floor(a),
        mFloat=(a-d)*60,m=Math.floor(mFloat),
        s=Math.round((mFloat-m)*60*10)/10;
  return `${d}Â°${m}'${s}"${dir}`;
}

/* åŠ å…¥ç´…è‰²æ³¢ç´‹å›ºå®šé»ï¼ˆç¤ºç¯„ç”¨ï¼‰ */
function addFixedMarkers(lat,lon){
  if(layerGroup) layerGroup.clearLayers();
  layerGroup=L.layerGroup();
  const pts=[
    {lat:lat+0.0005, lon:lon+0.0005},
    {lat:lat-0.0008, lon:lon-0.0005},
    {lat,              lon:lon+0.0009}
  ];
  const pulse=L.divIcon({className:'pulse-marker',iconSize:[16,16]});
  pts.forEach(p=>L.marker([p.lat,p.lon],{icon:pulse}).addTo(layerGroup));
  layerGroup.addTo(map);
}

function initMap(lat,lon){
  map=L.map('map').setView([lat,lon],15); // æ‰‹æ©Ÿä¸Š 15~16 è¼ƒé©ä¸­
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);
  marker=L.marker([lat,lon]).addTo(map);
  addFixedMarkers(lat,lon);
}

function updateLocation(pos){
  const {latitude:lat,longitude:lon} = pos.coords;
  statusEl.textContent = 'å®šä½æˆåŠŸï¼';
  const url=`https://www.google.com/maps/place/${encodeURIComponent(decimalToDMS(lat,true))}+${encodeURIComponent(decimalToDMS(lon,false))}`;
  latestMapURL=url;
  if(!map){
    initMap(lat,lon);
  }else{
    map.setView([lat,lon]);
    marker.setLatLng([lat,lon]);
    addFixedMarkers(lat,lon);
  }
}

function handleError(err){
  switch(err.code){
    case err.PERMISSION_DENIED:
      statusEl.textContent='âŒ ä½¿ç”¨è€…æ‹’çµ•å®šä½æ¬Šé™';break;
    case err.POSITION_UNAVAILABLE:
      statusEl.textContent='âŒ ç„¡æ³•å–å¾—å®šä½è³‡è¨Š';break;
    case err.TIMEOUT:
      statusEl.textContent='âŒ å–å¾—å®šä½é€¾æ™‚';break;
    default:
      statusEl.textContent='âŒ ä½ç½®éŒ¯èª¤ï¼š'+err.message;
  }
}

async function getLocation(){
  btn.disabled = true;
  statusEl.textContent='è«‹ç¨å€™ï¼Œæ­£åœ¨å–å¾—å®šä½â€¦';
  if(!('geolocation' in navigator)){
    statusEl.textContent='ç€è¦½å™¨ä¸æ”¯æ´å®šä½';
    btn.disabled=false;return;
  }
  // æª¢æŸ¥æ¬Šé™ç‹€æ…‹ï¼›è‹¥å·²è¢«å°é–ï¼Œå…ˆæç¤ºä½¿ç”¨è€…åˆ°è¨­å®šé–‹å•Ÿ
  if(navigator.permissions){
    const gStatus = await navigator.permissions.query({name:'geolocation'});
    if(gStatus.state==='denied'){
      statusEl.textContent='å®šä½æ¬Šé™è¢«å°é–ï¼Œè«‹åˆ°ç€è¦½å™¨è¨­å®šæ‰‹å‹•å…è¨±';
      btn.disabled=false;return;
    }
  }
  navigator.geolocation.getCurrentPosition(updateLocation,handleError,{enableHighAccuracy:true,timeout:10000});
  btn.disabled=false;
}

document.getElementById('loc-btn').addEventListener('click',getLocation);

function copyLink(){
  if(latestMapURL){
    navigator.clipboard.writeText(latestMapURL).then(()=>alert('åœ°åœ–é€£çµå·²è¤‡è£½ï¼'));
  }else{
    alert('åœ°åœ–å°šæœªå®šä½ï¼Œç„¡é€£çµå¯è¤‡è£½');
  }
}
</script>
</body>
</html>

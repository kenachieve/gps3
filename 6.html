<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¡¯ç¤ºä½ å‘¨é­çš„ XXX</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    #map { width: 100%; height: 400px; margin-top: 10px; }

    /* â–¼ ç´…è‰²åŠé€æ˜æ³¢ç´‹ï¼ˆå¯è‡ªè¡Œèª¿æ•´å¤§å°ã€é€æ˜åº¦ã€å‹•ç•«æ™‚é–“ç­‰ï¼‰ */
    .pulse-marker {
      position: relative;
      width: 16px;           /* â† åœ–ç¤ºå¯¬åº¦ */
      height: 16px;          /* â† åœ–ç¤ºé«˜åº¦ */
      border-radius: 50%;
      background: rgba(255,0,0,0.55);
    }
    .pulse-marker::before,
    .pulse-marker::after {
      content: "";
      position: absolute;
      left: 50%; top: 50%;
      width: 100%; height: 100%;
      border-radius: 50%;
      background: rgba(255,0,0,0.35);
      transform: translate(-50%,-50%) scale(0.8);
      animation: pulse 2.5s infinite; /* â† å‹•ç•«é•·åº¦ */
    }
    .pulse-marker::after { animation-delay: 1.25s; }

    @keyframes pulse {
      0%   { transform: translate(-50%,-50%) scale(0.8); opacity: 0.8; }
      70%  { transform: translate(-50%,-50%) scale(3);   opacity: 0; }
      100% { opacity: 0; }
    }
  </style>
</head>

<body>
  <h1>é¡¯ç¤ºä½ å‘¨é­çš„ XXX</h1>

  <!-- 1ï¸âƒ£ ä½¿ç”¨è€…æ‰‹å‹¢ â”€ é»æ“Šå¾Œæ‰è«‹æ±‚å®šä½ -->
  <button id="locBtn">ğŸ“ å–å¾—ç›®å‰ä½ç½®</button>
  &nbsp; <strong>åœ°åœ–ä½ç½®åˆ†äº«:</strong>
  <button id="copyBtn">ğŸ”— è¤‡è£½åœ°åœ–é€£çµ</button>

  <div id="map"></div>

  <script>
    let map, marker, layerGroup;
    let latestMapURL = '';     // ç›®å‰å®šä½å°æ‡‰çš„ Google Maps é€£çµï¼ˆä¾›è¤‡è£½ï¼‰

    /* ===== å·¥å…·å‡½å¼ ===== */

    // åé€²ä½ â†’ åº¦åˆ†ç§’ï¼ˆç”¨æ–¼çµ„æˆ Google Maps é€£çµï¼‰
    function decimalToDMS(deg, isLat = true) {
      const dir = deg >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
      const abs = Math.abs(deg);
      const d = Math.floor(abs);
      const mFloat = (abs - d) * 60;
      const m = Math.floor(mFloat);
      const s = Math.round((mFloat - m) * 60 * 10) / 10;
      return `${d}Â°${m}'${s}"${dir}`;
    }

    // åœ°åœ–åˆå§‹åŒ–
    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 15);   // â† è¦–é‡å¤§å°
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([lat, lon]).addTo(map);
      addFixedMarkers(lat, lon);
    }

    // åŠ å…¥ç´…è‰²æ³¢ç´‹æ¨™è¨˜ï¼ˆç¤ºç¯„ 3 å€‹é»ï¼Œå¯è‡ªè¡Œå¢åˆªï¼‰
    function addFixedMarkers(lat, lon) {
      if (layerGroup) layerGroup.clearLayers();
      layerGroup = L.layerGroup().addTo(map);

      const pts = [
        { lat: lat + 0.0005, lon: lon + 0.0005 },
        { lat: lat - 0.0008, lon: lon - 0.0005 },
        { lat: lat,          lon: lon + 0.0009 }
      ];
      const pulse = L.divIcon({ className: 'pulse-marker', iconSize: [16, 16] });

      pts.forEach(p => L.marker([p.lat, p.lon], { icon: pulse }).addTo(layerGroup));
    }

    // å®šä½æˆåŠŸå¾Œæ›´æ–°åœ°åœ–èˆ‡åˆ†äº«é€£çµ
    function updateLocation(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // Google Maps é€£çµ (åº¦åˆ†ç§’æ ¼å¼ï¼ŒSafari ä¸Šè¤‡è£½è¼ƒç¾è§€)
      latestMapURL =
        `https://www.google.com/maps/place/` +
        encodeURIComponent(decimalToDMS(lat, true)) + '+' +
        encodeURIComponent(decimalToDMS(lon, false));

      if (!map) {
        initMap(lat, lon);
      } else {
        map.setView([lat, lon], 15);
        marker.setLatLng([lat, lon]);
        addFixedMarkers(lat, lon);
      }
    }

    // éŒ¯èª¤è™•ç†ï¼ˆç°¡åŒ–ç‰ˆï¼‰
    function handleGeoError(err) {
      const msg = (err.code === 1)
        ? 'å·²æ‹’çµ•å®šä½æ¬Šé™ï¼Œè«‹åˆ° Safari è¨­å®š â†’ ç¶²ç«™ â†’ ä½ç½®ï¼Œæ”¹æˆã€Œå…è¨±ã€'
        : `å®šä½å¤±æ•—ï¼ˆéŒ¯èª¤ç¢¼ ${err.code}ï¼‰ï¼š${err.message}`;
      alert(msg);
    }

    // 2ï¸âƒ£ æŒ‰éˆ• â€“ è§¸ç™¼å®šä½
    document.getElementById('locBtn').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        updateLocation,
        handleGeoError,
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // 3ï¸âƒ£ æŒ‰éˆ• â€“ è¤‡è£½ Google Maps é€£çµ
    document.getElementById('copyBtn').addEventListener('click', () => {
      if (!latestMapURL) {
        alert('å°šæœªå®šä½ï¼Œæ²’æœ‰å¯è¤‡è£½çš„é€£çµ');
        return;
      }
      navigator.clipboard.writeText(latestMapURL)
        .then(() => alert('åœ°åœ–é€£çµå·²è¤‡è£½ï¼'))
        .catch(() => alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½'));
    });

    /* âœ… é€²éšï¼šå…ˆåµæ¸¬æ¬Šé™ç‹€æ…‹ï¼Œè‹¥å·²è¢«æ°¸ä¹…æ‹’çµ•å°±æå‰é¡¯ç¤ºæç¤º
       if (navigator.permissions) {
         navigator.permissions.query({ name: 'geolocation' }).then(p => {
           if (p.state === 'denied') {
             alert('æ‚¨å·²æ‹’çµ•å®šä½ï¼Œè«‹åˆ°ç€è¦½å™¨è¨­å®šä¸­é‡æ–°å…è¨±');
           }
         });
       }
    */
  </script>
</body>
</html>
